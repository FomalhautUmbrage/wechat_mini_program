<!-- 对 pages/rankings/index.wxml 文件的修改 -->
<t-navbar title="排行榜" left-arrow />
<view class="rankings-page">
  <!-- Top dropdown selector -->
  <view class="dropdown-container">
    <view class="ranking-dropdown" bind:tap="toggleDropdown">
      <text>{{rankingType}}</text>
      <t-icon name="caret-down-small" size="48rpx" />
    </view>
    
    <!-- 当前Excel文件名称显示 -->
    <view class="excel-info" wx:if="{{excelFileName}}">
      <t-icon name="file-excel" size="32rpx" />
      <text>{{excelFileName}}</text>
    </view>
    
    <!-- 时间筛选按钮 - 移到顶部右侧 -->
    <view class="top-time-filter">
      <view class="time-filter-btn" bind:tap="toggleTimeFilter">
        <text>{{timeRange}}</text>
        <t-icon name="caret-down-small" size="36rpx" />
      </view>
    </view>
  </view>
  
  <!-- 下拉选项列表，使用 placement="top" 并适配自定义导航栏，使其在标题下方展开 -->
  <t-popup visible="{{visible}}" bind:visible-change="onVisibleChange" placement="top" using-custom-navbar="{{true}}">
    <view class="popup-content">
      <view 
        class="popup-item {{item.label === rankingType ? 'active' : ''}}" 
        wx:for="{{rankingOptions}}" 
        wx:key="value" 
        data-value="{{item.value}}"
        data-label="{{item.label}}"
        bind:tap="handleOptionChange"
      >
        {{item.label}}
      </view>
    </view>
  </t-popup>
  
  <!-- 时间筛选下拉菜单 -->
  <t-popup visible="{{timeFilterVisible}}" bind:visible-change="onTimeFilterVisibleChange" placement="top" using-custom-navbar="{{true}}">
    <view class="popup-content">
      <view 
        class="popup-item {{item.label === timeRange ? 'active' : ''}}" 
        wx:for="{{timeOptions}}" 
        wx:key="value" 
        data-value="{{item.value}}"
        data-label="{{item.label}}"
        bind:tap="handleTimeOptionChange"
      >
        {{item.label}}
      </view>
    </view>
  </t-popup>

  <!-- 无数据状态提示 -->
  <view class="no-data-container" wx:if="{{!hasData && !loading}}">
    <t-empty icon="info-circle-filled" description="暂无排行榜数据" />
    <view class="no-data-tips">可以在"我的"页面上传排行榜数据</view>
  </view>

  <!-- Loading indicator -->
  <view class="loading-container" wx:if="{{loading}}">
    <t-loading theme="circular" size="48rpx" />
    <text class="loading-text">数据加载中...</text>
  </view>

  <!-- 关键修改：使用wx:if而不是CSS类进行控制，通过key属性强制重新渲染 -->
  <block wx:if="{{hasData && !loading}}">
    <!-- 使用podiumVisible控制显示，并使用animationKey强制重新渲染 -->
    <view wx:if="{{podiumVisible}}" class="podium-container animate-in" data-key="{{animationKey}}">
      <!-- Second place - left -->
      <view class="podium-item second">
        <view class="rank-avatar">
          <t-avatar wx:if="{{rankings.length > 1}}" image="{{rankings[1].avatar}}" size="large"></t-avatar>
        </view>
        <view class="podium-block">
          <view class="podium-number">2</view>
          <view class="podium-name" wx:if="{{rankings.length > 1}}">{{rankings[1].name}}</view>
          <view class="podium-value" wx:if="{{rankings.length > 1}}">{{rankings[1].value}}</view>
        </view>
      </view>

      <!-- First place - middle (taller) -->
      <view class="podium-item first">
        <view class="rank-avatar">
          <t-avatar wx:if="{{rankings.length > 0}}" image="{{rankings[0].avatar}}" size="large"></t-avatar>
        </view>
        <view class="podium-block">
          <view class="podium-number">1</view>
          <view class="podium-name" wx:if="{{rankings.length > 0}}">{{rankings[0].name}}</view>
          <view class="podium-value" wx:if="{{rankings.length > 0}}">{{rankings[0].value}}</view>
        </view>
      </view>

      <!-- Third place - right -->
      <view class="podium-item third">
        <view class="rank-avatar">
          <t-avatar wx:if="{{rankings.length > 2}}" image="{{rankings[2].avatar}}" size="large"></t-avatar>
        </view>
        <view class="podium-block">
          <view class="podium-number">3</view>
          <view class="podium-name" wx:if="{{rankings.length > 2}}">{{rankings[2].name}}</view>
          <view class="podium-value" wx:if="{{rankings.length > 2}}">{{rankings[2].value}}</view>
        </view>
      </view>
    </view>

    <!-- 排名列表也添加key属性实现强制重新渲染 -->
    <view class="rankings-list animate-in" data-key="{{animationKey}}">
      <t-cell-group>
        <t-cell
          wx:for="{{rankings}}"
          wx:key="index"
          wx:if="{{index > 2}}"
          hover
          bordered="{{index !== rankings.length - 1}}"
        >
          <view slot="left-icon" class="rank-number">{{index + 1}}</view>
          <view slot="title" class="rank-name">{{item.name}}</view>
          <view slot="description" class="rank-value">{{rankingType}}: {{item.value}}</view>
          <t-avatar slot="right-icon" image="{{item.avatar}}" size="small"></t-avatar>
        </t-cell>
      </t-cell-group>
    </view>
  </block>
</view>
<t-toast id="t-toast" />